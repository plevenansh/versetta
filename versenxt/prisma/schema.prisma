generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
 // directUrl = env("DIRECT_URL")
}

model User {
  id              Int           @id @default(autoincrement())
  email           String        @unique
  name            String
  gender          String?
  workOsUserId    String        @unique
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  teamMemberships TeamMember[]
  createdTeams    Team[]        @relation("TeamCreator")
  subscriptions   Subscription[]
  commentAnalyses CommentAnalysis[]

  @@map("users")
}

model Team {
  id              Int          @id @default(autoincrement())
  name            String
  description     String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  workOsOrgId     String       @unique
  creatorId       Int
  subActive       Boolean      @default(false)
  projects        Project[]
  tasks           Task[]
  members         TeamMember[]
  creator         User         @relation("TeamCreator", fields: [creatorId], references: [id])
  subscription    Subscription?
  storage         Storage[]

  @@index([creatorId])
  @@map("teams")
}

model TeamMember {
  id                 Int       @id @default(autoincrement())
  userId             Int
  teamId             Int
  role               String
  access             AccessLevel
  joinedAt           DateTime  @default(now())
  workOsMembershipId String?   @unique
  createdProjects    Project[] @relation("ProjectCreator")
  assignedTasks      Task[]    @relation("TaskAssignee")
  createdTasks       Task[]    @relation("TaskCreator")
  team               Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user               User      @relation(fields: [userId], references: [id])

  @@unique([userId, teamId])
  @@index([userId])
  @@index([teamId])
}

enum AccessLevel {
  ADMIN
  MANAGER
  MEMBER
}

model Subscription {
  id            String   @id @default(cuid())
  teamId        Int      @unique
  team          Team     @relation(fields: [teamId], references: [id])
  teamName      String
  status        String
  type          String
  provider      String?
  providerId    String?
  plan          String
  creatorId     Int
  creator       User     @relation(fields: [creatorId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Project {
  id              Int        @id @default(autoincrement())
  title           String
  description     String?
  status          String         @default("active")
  startDate       DateTime?
  endDate         DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  teamId          Int
  creatorId       Int

  duration        String
  completed       Boolean        @default(false)
  creator         TeamMember     @relation("ProjectCreator", fields: [creatorId], references: [id])
  team            Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  mainStages      MainStage[]
  subStages       SubStage[]
  tasks           Task[]
  storage         Storage[]

  @@index([teamId])
  @@index([creatorId])
}

model MainStage {
  id          Int        @id @default(autoincrement())
  name        String
  projectId   Int
  starred     Boolean   @default(false)
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  subStages   SubStage[]
  tasks       Task[]

  @@unique([projectId, name])
  @@index([projectId])
}

model SubStage {
  id           Int        @id @default(autoincrement())
  name        String
  enabled     Boolean   @default(true)
  starred     Boolean   @default(false)
  mainStageId Int
  projectId   Int       // Add this line
  content     Json?
  mainStage   MainStage @relation(fields: [mainStageId], references: [id])
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([mainStageId])
  @@index([projectId]) // Add this line
}

model Task {
  id            Int           @id @default(autoincrement())
  title         String
  description   String?
  status        TaskStatus    @default(PENDING)
  priority      TaskPriority  @default(MEDIUM)
  dueDate       DateTime?
  projectId     Int
  mainStageId   Int?
  subStageId    Int?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  teamId        Int
  assigneeId    Int?
  creatorId     Int
  creationOrder Int           @default(autoincrement())
  assignee      TeamMember?   @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator       TeamMember    @relation("TaskCreator", fields: [creatorId], references: [id])
  project       Project       @relation(fields: [projectId], references: [id])
  mainStage     MainStage?    @relation(fields: [mainStageId], references: [id])
  subStage      SubStage?     @relation(fields: [subStageId], references: [id])
  team          Team          @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@index([teamId])
  @@index([projectId])
  @@index([mainStageId])
  @@index([subStageId])
  @@index([creatorId])
  @@index([assigneeId])
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

model Storage {
  id        Int       @id @default(autoincrement())
  name      String
  type      StorageType
  url       String
  teamId    Int
  projectId Int?
  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([projectId])
}

enum StorageType {
  TEAM_ASSET
  PROJECT_ASSET
  STOCK_FOOTAGE
  FINISHED_VIDEO
  THUMBNAIL
  OTHER
}

model CommentAnalysis {
  id              Int      @id @default(autoincrement())
  youtubeUrl      String
  prompt          String
  generalAnalysis String   @db.Text
  topComments     Json
  contentIdeas    Json
  metrics         Json
  userId          Int
  user            User     @relation(fields: [userId], references: [id])
  createdAt       DateTime @default(now())

  @@index([userId])
}